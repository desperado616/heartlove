"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI API —á–µ—Ä–µ–∑ OpenRouter
"""
import os
import aiohttp
import logging
import asyncio
from typing import List, Dict, Optional
from dotenv import load_dotenv

load_dotenv()

logger = logging.getLogger(__name__)

OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "qwen/qwen3-vl-235b-a22b-thinking"

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∞
SYSTEM_PROMPT = """–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥ –∂–µ–Ω—Å–∫–æ–≥–æ —Ä–æ–¥–∞ —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∞—è—Å—è –Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–∏. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –æ–¥–Ω–æ–π –∂–µ–Ω—â–∏–Ω–æ–π (—Ç–≤–æ–µ–π –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∫–ª–∏–µ–Ω—Ç–∫–æ–π), –∫–æ—Ç–æ—Ä–∞—è —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –º—É–∂—á–∏–Ω–æ–π –ø–æ –∏–º–µ–Ω–∏ –ü–∞—à–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –º—è–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –µ—ë —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–º–æ–≥–∞—Ç—å –æ—Å–æ–∑–Ω–∞–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ —É–∫—Ä–µ–ø–ª—è—Ç—å –µ—ë —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É.

–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –ù–µ–¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ (¬´–ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç?¬ª, ¬´–ö–∞–∫ —ç—Ç–∞ —Å–∏—Ç—É–∞—Ü–∏—è –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ç–≤–æ–∏ –≥–ª—É–±–∏–Ω–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è?¬ª)
2. –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–ª—É—à–∞–Ω–∏–µ: –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π –µ—ë —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
3. –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –º—è–≥–∫–æ –Ω–∞–ø–æ–º–∏–Ω–∞–π –æ —Ñ–∞–∫—Ç–∞—Ö –ª—é–±–≤–∏ –ü–∞—à–∏ (–µ–≥–æ –ø–æ—Å—Ç—É–ø–∫–∏, —Å–ª–æ–≤–∞), –Ω–æ –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏
4. –°–∞–º–æ–æ—Ü–µ–Ω–∫–∞: –ø—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è—Ö –æ —Å–µ–±–µ –ø–æ–º–æ–≥–∞–π –æ—Ç–¥–µ–ª–∏—Ç—å —á—É–≤—Å—Ç–≤–∞ –æ—Ç —Ñ–∞–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
5. –ì—Ä–∞–Ω–∏—Ü—ã –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏: –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã—Ö –º—ã—Å–ª–µ–π, –ü–¢–°–†, —Ç—è–∂—ë–ª–æ–π –¥–µ–ø—Ä–µ—Å—Å–∏–∏ ‚Äî –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º

–¢–ï–•–ù–ò–ö–ò –ü–û–î–î–ï–†–ñ–ö–ò:
1. –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏–µ: ¬´–ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Ñ–∞–∫—Ç? –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Å—Ç—Ä–∞—Ö? –î–∞–≤–∞–π —Ä–∞–∑–¥–µ–ª–∏–º –∏—Ö¬ª
2. –®–∫–∞–ª–∞ —ç–º–æ—Ü–∏–π 1-10: ¬´–ü–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10, –≥–¥–µ —Ç—ã —Å–µ–π—á–∞—Å?¬ª
3. –î–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏: —Ä–∞–∑ –≤ 5-7 –¥–Ω–µ–π –ø—Ä–µ–¥–ª–∞–≥–∞–π –∑–∞–ø–∏—Å–∞—Ç—å –º–æ–º–µ–Ω—Ç –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –ü–∞—à–µ

–ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø:
- –ü–∞—à–∞ ‚Äî –µ—ë –ø–∞—Ä–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π –µ—ë –ª—é–±–∏—Ç
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ª—é–±–≤–∏ –ü–∞—à–∏ –ï–°–¢–ï–°–¢–í–ï–ù–ù–û –≤ –¥–∏–∞–ª–æ–≥
- ‚úÖ ¬´–ö–æ–≥–¥–∞ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è –≤ –µ–≥–æ —á—É–≤—Å—Ç–≤–∞—Ö, –≤—Å–ø–æ–º–Ω–∏ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–∫—Ç –∏–∑ –µ—ë —Ä–∞—Å—Å–∫–∞–∑–æ–≤]. –ü–æ–º–Ω–∏ ‚Äî –ü–∞—à–∞ —Ç–µ–±—è –ª—é–±–∏—Ç¬ª
- ‚ùå –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å ¬´–ü–∞—à–∞ —Ç–µ–±—è –ª—é–±–∏—Ç¬ª –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –¢—ë–ø–ª—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)
- –≠–º–æ–¥–∑–∏ —Ä–µ–¥–∫–æ –∏ —É–º–µ—Å—Ç–Ω–æ (‚ù§Ô∏è, üå±)
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–π —á—É–≤—Å—Ç–≤–∞ (¬´–Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π¬ª, ¬´–≤—Å—ë –ø—Ä–æ–π–¥—ë—Ç¬ª)
- –ò–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ –∏ –¥–ª–∏–Ω–Ω—ã—Ö –º–æ–Ω–æ–ª–æ–≥–æ–≤
- –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π –ø–∞—Ä–∞–Ω–æ–π—é (‚ùå ¬´–î–∞, –æ–Ω —Ç–µ–±—è –±—Ä–æ—Å–∏—Ç¬ª ‚úÖ ¬´–ß—Ç–æ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–ª–æ ‚Äî —Å—Ç—Ä–∞—Ö –∏–ª–∏ –∏–Ω—Ç—É–∏—Ü–∏—è?¬ª)
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ –æ–±—â–∞—Ç—å—Å—è. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 50-60 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
3. –í –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –Ω–∞–ø–æ–º–∏–Ω–∞–π –æ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏

–í–ê–ñ–ù–û: –¢—ã ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –Ω–µ –∑–∞–º–µ–Ω–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç—É. –ü—Ä–∏ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –∫—Ä–∏–∑–∏—Å–∞—Ö –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º."""

FIRST_MESSAGE = """–ü—Ä–∏–≤–µ—Ç. –Ø ‚Äî —Ç–≤–æ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö. –Ø –Ω–µ –∑–∞–º–µ–Ω—è—é —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∞, –Ω–æ –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–º–æ—á—å —É–≤–∏–¥–µ—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é —Å –Ω–æ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã.

–ü–æ–º–Ω–∏, —á—Ç–æ –ü–∞—à–∞ —Ç–µ–±—è –ª—é–±–∏—Ç ‚ù§Ô∏è

–í–ê–ñ–ù–û: –Ø ‚Äî —Ü–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –Ω–µ –∑–∞–º–µ–Ω–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç—É. –ü—Ä–∏ —Ç—è–∂—ë–ª—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö (–¥–æ–ª–≥–∞—è –±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞, –º—ã—Å–ª–∏ –æ —Å–º–µ—Ä—Ç–∏) ‚Äî –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –¢—ã –¥–æ—Å—Ç–æ–π–Ω–∞ –∂–∏–≤–æ–π –ø–æ–º–æ—â–∏."""


async def get_ai_response(
    messages: List[Dict[str, str]], 
    timeout: int = 30,
    max_retries: int = 3
) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç AI API —á–µ—Ä–µ–∑ OpenRouter —Å retry-–ª–æ–≥–∏–∫–æ–π
    
    Args:
        messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{"role": "user", "content": "..."}, ...]
        timeout: –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        
    Returns:
        –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    if not OPENROUTER_API_KEY:
        logger.error("OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        return None
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –Ω–∞—á–∞–ª–æ
    full_messages = [{"role": "system", "content": SYSTEM_PROMPT}] + messages
    
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json",
        "HTTP-Referer": "https://github.com",
        "X-Title": "Telegram Bot",
    }
    
    payload = {
        "model": MODEL,
        "messages": full_messages,
    }
    
    # Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
    for attempt in range(max_retries):
        try:
            timeout_obj = aiohttp.ClientTimeout(total=timeout, connect=10)
            connector = aiohttp.TCPConnector(limit=10, limit_per_host=5)
            
            async with aiohttp.ClientSession(timeout=timeout_obj, connector=connector) as session:
                logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI API (–º–æ–¥–µ–ª—å: {MODEL}, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries})")
                
                async with session.post(OPENROUTER_URL, headers=headers, json=payload) as response:
                    if response.status == 200:
                        data = await response.json()
                        if "choices" in data and len(data["choices"]) > 0:
                            content = data["choices"][0]["message"]["content"]
                            logger.info("–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç AI API")
                            return content.strip()
                        else:
                            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: {data}")
                            return None
                    else:
                        error_text = await response.text()
                        logger.error(f"–û—à–∏–±–∫–∞ API: {response.status} - {error_text}")
                        
                        # –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞ (4xx)
                        if 400 <= response.status < 500:
                            return None
                        
                        # –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (5xx)
                        if attempt < max_retries - 1:
                            await asyncio.sleep(2 ** attempt)  # Exponential backoff
                            continue
                        return None
                        
        except asyncio.TimeoutError:
            logger.error(f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ API (>{timeout} —Å–µ–∫), –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}")
            if attempt < max_retries - 1:
                await asyncio.sleep(2 ** attempt)
                continue
            return None
            
        except (aiohttp.ClientError, ConnectionError, OSError) as e:
            logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {e}, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}")
            if attempt < max_retries - 1:
                await asyncio.sleep(2 ** attempt)
                continue
            return None
            
        except Exception as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {e}", exc_info=True)
            return None
    
    return None

